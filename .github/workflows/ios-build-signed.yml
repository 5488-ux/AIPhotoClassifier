name: iOS Cloud Build (Signed IPA)

on:
  workflow_dispatch:
    inputs:
      export_method:
        description: '导出方式'
        required: false
        default: 'development'
        type: choice
        options:
          - development
          - ad-hoc
          - app-store
      configuration:
        description: '构建配置'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
      cert_password:
        description: '证书密码 (P12 password)'
        required: true
        type: string
  push:
    tags:
      - 'v*'

env:
  PROJECT_NAME: AIPhotoClassifier
  SCHEME: AIPhotoClassifier
  SDK: iphoneos
  BUNDLE_ID: com.aiphoto.classifier
  CONFIGURATION: ${{ github.event.inputs.configuration || 'Release' }}
  EXPORT_METHOD: ${{ github.event.inputs.export_method || 'development' }}

jobs:
  build-signed:
    name: Signed IPA (${{ github.event.inputs.export_method || 'development' }})
    runs-on: macos-15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Show build environment
      run: |
        echo "Xcode version:"
        xcodebuild -version
        echo ""
        echo "Configuration: ${{ env.CONFIGURATION }}"
        echo "Export method: ${{ env.EXPORT_METHOD }}"

    - name: Install Apple Certificate and Provisioning Profile
      env:
        CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
        CERT_PASSWORD: ${{ github.event.inputs.cert_password || secrets.CERTIFICATES_P12_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
        KEYCHAIN_PASSWORD: ${{ github.event.inputs.cert_password || 'temp_keychain_pwd' }}
      run: |
        # 创建临时路径
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        PP_PATH=$RUNNER_TEMP/profile.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        # 解码证书和 Provisioning Profile
        echo -n "$CERTIFICATES_P12" | base64 --decode -o $CERTIFICATE_PATH
        echo -n "$PROVISIONING_PROFILE" | base64 --decode -o $PP_PATH

        # 验证 P12 文件
        echo "P12 file size: $(wc -c < $CERTIFICATE_PATH) bytes"

        # 创建临时钥匙串
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # 导入证书（使用手动输入的密码或 secret）
        echo "Importing certificate..."
        security import $CERTIFICATE_PATH -P "$CERT_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

        # 安装 Provisioning Profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

        # 显示已安装的证书
        echo "Installed certificates:"
        security find-identity -v -p codesigning

    - name: Build and Archive
      env:
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        xcodebuild clean archive \
          -project ${PROJECT_NAME}.xcodeproj \
          -scheme ${SCHEME} \
          -archivePath $RUNNER_TEMP/${PROJECT_NAME}.xcarchive \
          -sdk ${SDK} \
          -configuration ${{ env.CONFIGURATION }} \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_STYLE=Automatic \
          DEVELOPMENT_TEAM=$TEAM_ID \
          ENABLE_BITCODE=NO

    - name: Export IPA
      env:
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        # 根据导出方式选择签名证书
        if [ "${{ env.EXPORT_METHOD }}" = "app-store" ]; then
          SIGNING_CERT="Apple Distribution"
        else
          SIGNING_CERT="Apple Development"
        fi

        # 生成 ExportOptions.plist
        cat > $RUNNER_TEMP/ExportOptions.plist << PLIST
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>${{ env.EXPORT_METHOD }}</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>uploadSymbols</key>
            <true/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
        </dict>
        </plist>
        PLIST

        # 导出 IPA
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/${PROJECT_NAME}.xcarchive \
          -exportPath $RUNNER_TEMP/build \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist

        # 移动到 build 目录
        mkdir -p build
        cp $RUNNER_TEMP/build/${PROJECT_NAME}.ipa build/

        # 显示 IPA 信息
        if [ -f "build/${PROJECT_NAME}.ipa" ]; then
          IPA_SIZE=$(du -h "build/${PROJECT_NAME}.ipa" | cut -f1)
          echo "IPA created: build/${PROJECT_NAME}.ipa (${IPA_SIZE})"
        fi

    - name: Package dSYMs
      run: |
        DSYM_PATH="$RUNNER_TEMP/${PROJECT_NAME}.xcarchive/dSYMs"
        if [ -d "${DSYM_PATH}" ] && [ "$(ls -A ${DSYM_PATH} 2>/dev/null)" ]; then
          cd $RUNNER_TEMP
          zip -r -q "${PROJECT_NAME}-dSYMs.zip" "${PROJECT_NAME}.xcarchive/dSYMs/"
          cp "${PROJECT_NAME}-dSYMs.zip" $GITHUB_WORKSPACE/build/
          cd -
          echo "dSYM archive created"
        fi

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-IPA-Signed
        path: build/${{ env.PROJECT_NAME }}.ipa
        retention-days: 30

    - name: Upload dSYMs
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-dSYMs
        path: build/${{ env.PROJECT_NAME }}-dSYMs.zip
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload Archive
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-Archive-Signed
        path: ${{ runner.temp }}/${{ env.PROJECT_NAME }}.xcarchive
        retention-days: 15

    - name: Cleanup
      if: always()
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        rm -rf $RUNNER_TEMP/certificate.p12
        rm -rf $RUNNER_TEMP/profile.mobileprovision
        rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision

    - name: Build Summary
      if: always()
      run: |
        echo "## AIPhotoClassifier Signed Build" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "build/${PROJECT_NAME}.ipa" ]; then
          IPA_SIZE=$(du -h "build/${PROJECT_NAME}.ipa" | cut -f1)
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Success |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | ${{ env.CONFIGURATION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Export Method | ${{ env.EXPORT_METHOD }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IPA Size | ${IPA_SIZE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Team ID | ${{ secrets.TEAM_ID }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download" >> $GITHUB_STEP_SUMMARY
          echo "Download **${PROJECT_NAME}-IPA-Signed** from Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install" >> $GITHUB_STEP_SUMMARY
          echo "1. **Xcode**: Window -> Devices and Simulators -> drag IPA" >> $GITHUB_STEP_SUMMARY
          echo "2. **Apple Configurator 2**: Add -> Apps -> select IPA" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.EXPORT_METHOD }}" = "app-store" ]; then
            echo "3. **Transporter**: Upload to App Store Connect" >> $GITHUB_STEP_SUMMARY
          else
            echo "3. **AltStore / Sideloadly**: Direct install" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "Build failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Secrets" >> $GITHUB_STEP_SUMMARY
          echo "Make sure these are configured in Settings -> Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "- \`CERTIFICATES_P12\`: Base64-encoded .p12 certificate" >> $GITHUB_STEP_SUMMARY
          echo "- \`PROVISIONING_PROFILE\`: Base64-encoded .mobileprovision" >> $GITHUB_STEP_SUMMARY
          echo "- \`TEAM_ID\`: Apple Developer Team ID" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "触发时在 **cert_password** 输入框填写证书密码即可" >> $GITHUB_STEP_SUMMARY
        fi
