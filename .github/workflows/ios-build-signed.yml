name: iOS Build (Signed - IPA)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ç‰ˆæœ¬tagæ—¶è§¦å‘

jobs:
  build-signed:
    runs-on: macos-14

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Install Apple Certificate and Provisioning Profile
      env:
        CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
        CERTIFICATES_P12_PASSWORD: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        PP_PATH=$RUNNER_TEMP/profile.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        # è§£ç è¯ä¹¦å’ŒProfile
        echo -n "$CERTIFICATES_P12" | base64 -D > $CERTIFICATE_PATH
        echo -n "$PROVISIONING_PROFILE" | base64 -D > $PP_PATH

        # éªŒè¯æ–‡ä»¶å·²åˆ›å»º
        ls -lh $CERTIFICATE_PATH $PP_PATH

        # åˆ›å»ºä¸´æ—¶é’¥åŒ™ä¸²
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # ä½¿ç”¨opensslæå–è¯ä¹¦å’Œç§é’¥ï¼Œç„¶åŽå¯¼å…¥ï¼ˆé¿å…security importçš„PKCS12å¯†ç é—®é¢˜ï¼‰
        openssl pkcs12 -in $CERTIFICATE_PATH -clcerts -nokeys -out $RUNNER_TEMP/cert.pem -passin pass:1
        openssl pkcs12 -in $CERTIFICATE_PATH -nocerts -nodes -out $RUNNER_TEMP/key.pem -passin pass:1

        # å¯¼å…¥è¯ä¹¦å’Œç§é’¥
        security import $RUNNER_TEMP/cert.pem -k $KEYCHAIN_PATH -A
        security import $RUNNER_TEMP/key.pem -k $KEYCHAIN_PATH -A

        # è®¾ç½®å¯†é’¥è®¿é—®æƒé™
        security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        security list-keychain -d user -s $KEYCHAIN_PATH

        # éªŒè¯è¯ä¹¦å·²å¯¼å…¥
        security find-identity -v -p codesigning $KEYCHAIN_PATH

        # å®‰è£…Provisioning Profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

        # æ˜¾ç¤ºå·²å®‰è£…çš„è¯ä¹¦
        security find-identity -v -p codesigning

    - name: Build and Archive
      env:
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        xcodebuild clean archive \
          -project AIPhotoClassifier.xcodeproj \
          -scheme AIPhotoClassifier \
          -archivePath $RUNNER_TEMP/AIPhotoClassifier.xcarchive \
          -sdk iphoneos \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM=$TEAM_ID \
          CODE_SIGN_IDENTITY="iPhone Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="00008140-001611291A22801C2KHKUR" \
          PRODUCT_BUNDLE_IDENTIFIER="app.mango7143.test8374"

    - name: Export IPA
      run: |
        # åˆ›å»ºExportOptions.plist
        cat > $RUNNER_TEMP/ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>teamID</key>
            <string>${{ secrets.TEAM_ID }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string>iPhone Distribution</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>app.mango7143.test8374</key>
                <string>00008140-001611291A22801C2KHKUR</string>
            </dict>
        </dict>
        </plist>
        EOF

        # å¯¼å‡ºIPA
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/AIPhotoClassifier.xcarchive \
          -exportPath $RUNNER_TEMP/build \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist

        # ç§»åŠ¨åˆ°buildç›®å½•
        mkdir -p build
        cp $RUNNER_TEMP/build/AIPhotoClassifier.ipa build/

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: AIPhotoClassifier-IPA-Signed
        path: build/AIPhotoClassifier.ipa
        retention-days: 30

    - name: Upload Archive
      uses: actions/upload-artifact@v4
      with:
        name: AIPhotoClassifier-Archive-Signed
        path: ${{ runner.temp }}/AIPhotoClassifier.xcarchive
        retention-days: 30

    - name: Cleanup
      if: always()
      run: |
        # åˆ é™¤ä¸´æ—¶é’¥åŒ™ä¸²
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        rm -rf $RUNNER_TEMP/certificate.p12
        rm -rf $RUNNER_TEMP/profile.mobileprovision
        rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision

    - name: Build Summary
      if: success()
      run: |
        echo "## ðŸŽ‰ ç­¾åæž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **IPAå·²ç”Ÿæˆ**: build/AIPhotoClassifier.ipa" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **ç­¾åç±»åž‹**: Development" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Team ID**: ${{ secrets.TEAM_ID }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        echo "åœ¨Artifactsä¸­ä¸‹è½½ **AIPhotoClassifier-IPA-Signed**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± å®‰è£…æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
        echo "1. ä½¿ç”¨Xcode: Window â†’ Devices â†’ æ‹–å…¥IPA" >> $GITHUB_STEP_SUMMARY
        echo "2. ä½¿ç”¨AltStore/Sideloadly" >> $GITHUB_STEP_SUMMARY
        echo "3. é€šè¿‡TestFlightåˆ†å‘" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æ˜¾ç¤ºIPAæ–‡ä»¶ä¿¡æ¯
        if [ -f "build/AIPhotoClassifier.ipa" ]; then
          echo "### ðŸ“Š IPAä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          ls -lh build/AIPhotoClassifier.ipa | awk '{print "**å¤§å°**: " $5}' >> $GITHUB_STEP_SUMMARY
        fi
