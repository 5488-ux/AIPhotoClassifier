name: iOS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Build project
      run: |
        xcodebuild clean build \
          -project AIPhotoClassifier.xcodeproj \
          -scheme AIPhotoClassifier \
          -sdk iphoneos \
          -configuration Release \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create Archive
      run: |
        xcodebuild archive \
          -project AIPhotoClassifier.xcodeproj \
          -scheme AIPhotoClassifier \
          -archivePath build/AIPhotoClassifier.xcarchive \
          -sdk iphoneos \
          -configuration Release \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create ExportOptions.plist
      run: |
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>compileBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF

    - name: Export IPA (Optional - requires signing)
      continue-on-error: true
      run: |
        xcodebuild -exportArchive \
          -archivePath build/AIPhotoClassifier.xcarchive \
          -exportPath build \
          -exportOptionsPlist ExportOptions.plist || echo "âš ï¸  IPA export skipped (no signing certificates)"

    - name: Upload Archive (Always)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: AIPhotoClassifier-Archive
        path: build/AIPhotoClassifier.xcarchive
        retention-days: 30

    - name: Upload IPA (if exists)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: AIPhotoClassifier-IPA
        path: build/*.ipa
        retention-days: 30
        if-no-files-found: ignore

    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Build Status**: Success" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Archive Created**: build/AIPhotoClassifier.xcarchive" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "build/*.ipa" ]; then
          echo "âœ… **IPA Generated**: Yes" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸  **IPA Generated**: No (requires signing certificates)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Download Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **AIPhotoClassifier-Archive**: Xcode archive file" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ’¡ Note" >> $GITHUB_STEP_SUMMARY
        echo "IPA generation requires Apple Developer certificates." >> $GITHUB_STEP_SUMMARY
        echo "The archive can be opened in Xcode and run on simulators/devices." >> $GITHUB_STEP_SUMMARY
